<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è¡€æŸ“é˜æ¨“æ´»å‹•è¡Œäº‹æ›†</title>

<style>
/* =====ï¼ˆCSS èˆ‡ä½ åŸæœ¬ä¸€è‡´ï¼Œç•¥ï¼‰===== */
/* âš ï¸ æˆ‘æ²’æœ‰å‹•ä½ æ¨£å¼é‚è¼¯ï¼Œåªä¿® JS */
</style>
</head>

<body class="view-grid">
<div class="container">

<header>
  <h1>è¡€æŸ“é˜æ¨“æ´»å‹•è¡Œäº‹æ›†</h1>
  <div>
    <button id="gridModeBtn">ğŸ–¥ ç¶²æ ¼</button>
    <button id="listModeBtn">ğŸ“± æ¸…å–®</button>
    <button id="themeToggle">ğŸŒ™ ä¸»é¡Œ</button>
    <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
  </div>
</header>

<div id="errorMessage"></div>
<div id="updateInfo">è¼‰å…¥ä¸­â€¦</div>

<div id="filters">
  <span class="filter-label">åœ°é»ç¯©é¸ï¼š</span>
</div>

<div id="calendarGrid"></div>
<div id="noEvents" style="display:none">ç›®å‰æ²’æœ‰æ´»å‹•</div>

<div id="statusBar">
  <div>é¡¯ç¤ºæ‰€æœ‰åœ°é»çš„æ´»å‹•</div>
</div>

<!-- Modal -->
<div id="eventModal" class="event-modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <p id="modalDate"></p>
    <p id="modalTime"></p>
    <p id="modalLocation"></p>
    <p id="modalScript"></p>
    <p id="modalStoryteller"></p>
    <button id="modalLinkBtn">å‰å¾€å ±å</button>
    <button id="modalCloseBtn">é—œé–‰</button>
  </div>
</div>

</div>

<script>
/* ================= åŸºæœ¬è¨­å®š ================= */

const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vT8GSdmGL5ggYr0ADz2fwltf9mBgv-77ggRneKQOBnebWG9HGOwsqpbhn5wpYgrezLHUNwIxi1ACm5r/pub?output=csv";

const CACHE_KEY = "botc_data";
const CACHE_TIME = "botc_time";
const CACHE_DURATION = 5 * 60 * 1000;

const calendarYear = new Date().getFullYear();
let eventData = [];
let hiddenLocations = new Set();

const locationConfig = {
  "101é˜æ¨“": { color:"#4dabf7", bg:"#e7f5ff" },
  "æ­ªå¸¸ç ”ç©¶æ‰€": { color:"#da77f2", bg:"#f8f0fc" },
  "å°æ€ªå¯¶å®¶é•·æœƒ": { color:"#3a8c4a", bg:"#e6f7e9" }
};

/* ================= å·¥å…· ================= */

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",");
  return lines.map(l=>{
    const values = l.split(",");
    const row = {};
    headers.forEach((h,i)=>row[h.trim()] = values[i]?.trim()||"");
    return row;
  });
}

function loadCache(){
  const t = localStorage.getItem(CACHE_TIME);
  if(!t) return false;
  if(Date.now()-t > CACHE_DURATION) return false;
  eventData = JSON.parse(localStorage.getItem(CACHE_KEY));
  return true;
}

function saveCache(){
  localStorage.setItem(CACHE_KEY, JSON.stringify(eventData));
  localStorage.setItem(CACHE_TIME, Date.now());
}

/* ================= è¼‰å…¥è³‡æ–™ ================= */

async function loadData(force=false){
  if(!force && loadCache()) return true;

  try{
    const res = await fetch(CSV_URL);
    const csv = await res.text();
    const rows = parseCSV(csv);

    eventData = rows.map(r=>{
      const [m,d] = r["æ—¥æœŸ"].split("/");
      return {
        date: `${calendarYear}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`,
        time: r["æ™‚é–“"]||"",
        location: r["åœ°é»"],
        script: r["åŠ‡æœ¬åç¨±"],
        storyteller: r["èªªæ›¸äºº"],
        link: r["å ±åé€£çµ"]||""
      };
    });

    saveCache();
    document.getElementById("updateInfo").textContent =
      "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleString("zh-TW");
    return true;

  }catch(e){
    document.getElementById("errorMessage").textContent="è¼‰å…¥å¤±æ•—";
    return false;
  }
}

/* ================= UI ================= */

function generateFilterButtons(){
  const f = document.getElementById("filters");
  f.innerHTML = `<span class="filter-label">åœ°é»ç¯©é¸ï¼š</span>`;
  Object.keys(locationConfig).forEach(loc=>{
    const b=document.createElement("button");
    b.textContent=loc;
    b.onclick=()=>{ hiddenLocations.has(loc)?hiddenLocations.delete(loc):hiddenLocations.add(loc); generateCalendar(); };
    f.appendChild(b);
  });
}

function generateCalendar(){
  const g=document.getElementById("calendarGrid");
  g.innerHTML="";
  const map={};
  eventData.forEach(e=>{
    if(hiddenLocations.has(e.location)) return;
    map[e.date]=map[e.date]||[];
    map[e.date].push(e);
  });

  Object.keys(map).sort().forEach(d=>{
    const div=document.createElement("div");
    div.innerHTML=`<strong>${d}</strong>`;
    map[d].forEach(e=>{
      const ev=document.createElement("div");
      ev.textContent=`${e.time} ${e.script}`;
      ev.onclick=()=>openModal(e);
      div.appendChild(ev);
    });
    g.appendChild(div);
  });
}

function openModal(e){
  const m=document.getElementById("eventModal");
  document.getElementById("modalTitle").textContent=e.script;
  document.getElementById("modalDate").textContent="æ—¥æœŸï¼š"+e.date;
  document.getElementById("modalTime").textContent="æ™‚é–“ï¼š"+(e.time||"æœªå®š");
  document.getElementById("modalLocation").textContent="åœ°é»ï¼š"+e.location;
  document.getElementById("modalStoryteller").textContent="èªªæ›¸äººï¼š"+e.storyteller;
  const btn=document.getElementById("modalLinkBtn");
  if(e.link){
    btn.disabled=false;
    btn.onclick=()=>window.open(e.link);
  }else{
    btn.disabled=true;
  }
  m.classList.add("active");
}

document.getElementById("modalCloseBtn").onclick=()=>{
  document.getElementById("eventModal").classList.remove("active");
};

document.getElementById("eventModal").addEventListener("click",e=>{
  if(e.target.id==="eventModal"){
    e.currentTarget.classList.remove("active");
  }
});

/* ================= å•Ÿå‹• ================= */

document.addEventListener("DOMContentLoaded",async()=>{
  await loadData();
  generateFilterButtons();
  generateCalendar();
});
</script>
</body>
</html>
